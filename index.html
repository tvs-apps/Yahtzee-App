<!DOCTYPE html>
<html lang="en">
<head>
<!-- PWA Support -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007acc">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Yahtzee Scorekeeper">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yahtzee Scorekeeper</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
h1 { text-align: center; margin: 20px 0; }
#playerSetup { max-width: 500px; margin: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
input, select, button { font-size: 16px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
button { background: #007acc; color: white; cursor: pointer; border: none; }
button:hover { background: #005ea3; }
.score-card { border-radius: 10px; padding: 12px; margin: 10px auto; max-width: 480px; color:white; }
.category-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.3); }
.category-row.locked { background: rgba(0,0,0,0.2); color: #ccc; }
.category-label { flex: 1; }
.score-input, select { width: 80px; text-align: center; }
.quick-buttons { display: flex; gap: 4px; margin-left: 6px; flex-wrap: wrap; }
#footer { position: sticky; bottom: 0; background: #f9f9f9; padding: 10px; text-align: center; box-shadow: 0 -2px 6px rgba(0,0,0,0.1); display:none; }
#runningTotals { font-size: 14px; margin-bottom: 8px; }
.totals { font-weight: bold; margin-top: 8px; }
#statsDashboard { display: none; max-width: 500px; margin: 20px auto; }
.stat-card { background: #007acc; color: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
.stat-card h3 { margin: 0 0 10px 0; text-align: center; cursor: pointer; }
.stat-card button {
  border: 2px solid #d9534f;  /* bright red border */
  background: #fff;            /* white background */
  color: #d9534f;              /* red text */
  font-weight: bold;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 6px;
  width: 100%;
  transition: background 0.2s, color 0.2s;
}

.stat-card button:hover {
  background: #d9534f;
  color: white;
}
.stat-item { display: flex; justify-content: space-between; padding: 2px 0; font-size: 14px; }
.player-list-item { display:flex; justify-content:space-between; align-items:center; gap:4px; }
.modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; }
.modal { background:white; padding:20px; border-radius:10px; max-width:320px; text-align:center; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
.modal button { width: 100%; margin: 6px 0; }
</style>
</head>
<body>

<h1>Yahtzee Scorekeeper</h1>

<div id="playerSetup">
  <input type="text" id="playerName" placeholder="Enter player name">
  <button onclick="addPlayer()">Add Player</button>
  <div id="playerList"></div>
  <button onclick="startGame()">Start Game</button>
  <button onclick="showStats()">Show Stats</button>
  <button onclick="hideStats()">Hide Stats</button>
</div>

<div id="playerCardContainer" style="display:none"></div>

<div id="footer">
  <div id="runningTotals"></div>
  <button onclick="showEndGameModal()">End Game</button>
</div>

<div id="statsDashboard"></div>

<div id="endGameModal" class="modal-overlay">
  <div class="modal">
    <h3>End Game</h3>
    <p>What would you like to do?</p>
    <button onclick="endGame(false)">End Without Saving</button>
    <button onclick="endGame(true)">End & Save</button>
    <button onclick="closeEndGameModal()">Cancel</button>
  </div>
</div>

<div id="summaryModal" class="modal-overlay">
  <div class="modal">
    <h3>Game Summary</h3>
    <div id="summaryContent"></div>
    <button onclick="closeSummaryModal()">Close</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = { apiKey:"YOUR_API_KEY", authDomain:"YOUR_PROJECT_ID.firebaseapp.com", projectId:"YOUR_PROJECT_ID" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
db.enablePersistence().catch(err => console.log("Firestore persistence error:", err));

const categories = [
  "Aces","Twos","Threes","Fours","Fives","Sixes",
  "3 of a Kind","4 of a Kind","Full House","Small Straight","Large Straight",
  "Yahtzee","Yahtzee Bonus","Chance"
];
const fixedValueCategories = {"Full House":[25],"Small Straight":[30],"Large Straight":[40],"Yahtzee":[50]};
let players = [];
let gameHistory = [];
let currentPlayerIndex = 0;
let turnMode = false;
let lastAction = null;
let pendingYahtzeeBonus = false;
let yahtzeeBonusUsedThisTurn = false;

// Load history
if(localStorage.getItem("yahtzeeGameHistory")){
  gameHistory = JSON.parse(localStorage.getItem("yahtzeeGameHistory"));
}
db.collection("yahtzeeGames").onSnapshot(snapshot=>{
  gameHistory = snapshot.docs.map(doc => doc.data());
  localStorage.setItem("yahtzeeGameHistory", JSON.stringify(gameHistory));
  updateStatsDashboard();
});

// --- Player management ---
function randomColor(){ const r=Math.floor(Math.random()*150)+50; const g=Math.floor(Math.random()*150)+50; const b=Math.floor(Math.random()*150)+50; return `rgb(${r},${g},${b})`; }
function addPlayer(){
  const name = document.getElementById("playerName").value.trim();
  if(!name) return;
  players.push({name,scores:{},locked:{},color:randomColor(), yahtzeeBonusCount:0});
  document.getElementById("playerName").value="";
  renderPlayerList();
}
function removePlayer(i){ players.splice(i,1); renderPlayerList(); }
function renderPlayerList(){
  const list = document.getElementById("playerList");
  list.innerHTML="";
  players.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className="player-list-item";
    div.innerHTML=`${i+1}. ${p.name} 
      <span>
        <button onclick="movePlayerUp(${i})">â†‘</button>
        <button onclick="movePlayerDown(${i})">â†“</button>
        <button onclick="removePlayer(${i})">âœ–</button>
      </span>`;
    list.appendChild(div);
  });
}
function movePlayerUp(i){ if(i===0) return; [players[i-1],players[i]]=[players[i],players[i-1]]; renderPlayerList(); }
function movePlayerDown(i){ if(i===players.length-1) return; [players[i+1],players[i]]=[players[i+1],players[i]]; renderPlayerList(); }

// --- Game Start ---
function startGame(){
  if(players.length===0) return alert("Add at least one player");
  turnMode=true; currentPlayerIndex=0;
  document.getElementById("playerSetup").style.display="none";
  document.getElementById("playerCardContainer").style.display="block";
  document.getElementById("footer").style.display="block";
  renderPlayerCard();
}

// --- Scorecard Rendering ---
function renderPlayerCard(){
  const container = document.getElementById("playerCardContainer");
  container.innerHTML="";
  const player = players[currentPlayerIndex];
  const card = document.createElement("div");
  card.className="score-card";
  card.style.background = player.color;
  card.innerHTML=`<h2>${player.name}</h2>`;

  categories.forEach(cat=>{
    const locked = player.locked[cat];
    const row = document.createElement("div");
    row.className="category-row" + (locked?" locked":"");
    let inner=`<div class="category-label">${cat}</div>`;

    if(["Aces","Twos","Threes","Fours","Fives","Sixes"].includes(cat)){
      const num=["Aces","Twos","Threes","Fours","Fives","Sixes"].indexOf(cat)+1;
      const maxVal=num*5;
      if(locked){ inner+=`<div>${player.scores[cat]||0}</div>`; }
      else{
        inner+=`<div class="quick-buttons">${[2,3,4].map(mult=>{ const val=mult*num; return val<=maxVal?`<button onclick="updateScore('${cat}',${val})">${val}</button>`:""; }).join('')}</div>`;
        let options = `<option value="">--</option><option value="${num}">${num}</option><option value="${maxVal}">${maxVal}</option>`;
        inner+=`<select onchange="updateScore('${cat}',this.value)">${options}</select>`;
        inner+=`<button onclick="updateScore('${cat}',0)">Scratch</button>`;
      }
    }
    else if(["3 of a Kind","4 of a Kind"].includes(cat)){
      if(locked){ inner+=`<div>${player.scores[cat]||0}</div>`; }
      else{
        let options="<option value=''>--</option>";
        for(let i=0;i<=30;i++) options+=`<option value="${i}">${i}</option>`;
        inner+=`<select onchange="updateScore('${cat}',this.value)">${options}</select>`;
        inner+=`<button onclick="updateScore('${cat}',0)">Scratch</button>`;
      }
    }
    else if(cat==="Chance"){
      if(locked){ inner+=`<div>${player.scores[cat]||0}</div>`; }
      else{
        let options="<option value=''>--</option>";
        for(let i=1;i<=30;i++) options+=`<option value="${i}">${i}</option>`;
        inner+=`<select onchange="updateScore('${cat}',this.value)">${options}</select>`;
      }
    }
    else if(fixedValueCategories[cat]){
      if(locked){ inner+=`<div>${player.scores[cat]||0}</div>`; }
      else{ inner+=`<div class="quick-buttons">${fixedValueCategories[cat].map(v=>`<button onclick="updateScore('${cat}',${v})">${v}</button>`).join('')}<button onclick="updateScore('${cat}',0)">Scratch</button></div>`; }
    }
    else if(cat==="Yahtzee Bonus"){
      let xMarks = "X".repeat(player.yahtzeeBonusCount || 0);
      if(player.locked["Yahtzee"] !== true || yahtzeeBonusUsedThisTurn || locked){
        inner += `<div>${player.scores[cat]||0} ${xMarks} (locked)</div>`;
      } else {
        inner += `<button onclick="incrementYahtzeeBonus()">+100</button> <span>${xMarks}</span>`;
      }
    }

    row.innerHTML=inner;
    card.appendChild(row);
  });

  const upperTotal = ["Aces","Twos","Threes","Fours","Fives","Sixes"].reduce((s,c)=>s+(player.scores[c]||0),0);
  const bonus = upperTotal>=63?35:0;
  const lowerTotal = ["3 of a Kind","4 of a Kind","Full House","Small Straight","Large Straight","Yahtzee","Yahtzee Bonus","Chance"].reduce((s,c)=>s+(player.scores[c]||0),0);
  const grandTotal = upperTotal+bonus+lowerTotal;
  const totalsDiv = document.createElement("div");
  totalsDiv.className="totals";
  totalsDiv.innerText=`Upper: ${upperTotal} Bonus: ${bonus} | Lower: ${lowerTotal} | Grand: ${grandTotal}`;
  card.appendChild(totalsDiv);

  card.innerHTML+=`<button onclick="undoScore()">Undo Last Input</button>`;
  container.appendChild(card);

  updateRunningTotals();
}

// --- Score Handling ---
function updateScore(cat,val){
  const player = players[currentPlayerIndex];
  lastAction = {
    playerIndex: currentPlayerIndex,
    cat,
    valOld: player.scores[cat] || 0,
    yahtzeeBonusUsedPrev: yahtzeeBonusUsedThisTurn
  };
  if(val === "") return;

  player.scores[cat] = parseInt(val) || 0;
  player.locked[cat] = true;

  if(cat === "Yahtzee" && player.scores[cat] === 50){
    player.locked["Yahtzee Bonus"] = false;
  } else if(cat === "Yahtzee" && player.scores[cat] === 0){
    player.locked["Yahtzee Bonus"] = true;
  }

  if(cat !== "Yahtzee Bonus"){
    yahtzeeBonusUsedThisTurn = false;
    nextPlayer();
  }

  renderPlayerCard();
}

function incrementYahtzeeBonus(){
  const player = players[currentPlayerIndex];
  if(yahtzeeBonusUsedThisTurn) return;
  player.scores["Yahtzee Bonus"] = (player.scores["Yahtzee Bonus"] || 0) + 100;
  player.yahtzeeBonusCount = (player.yahtzeeBonusCount || 0) + 1;
  yahtzeeBonusUsedThisTurn = true;
  renderPlayerCard();
}

function undoScore(){
  if(!lastAction) return;
  const {playerIndex,cat,valOld, yahtzeeBonusUsedPrev}=lastAction;
  currentPlayerIndex=playerIndex;
  const player = players[currentPlayerIndex];
  player.scores[cat]=valOld;
  player.locked[cat]=false;
  if(cat==="Yahtzee Bonus") player.yahtzeeBonusCount = Math.max(0, player.yahtzeeBonusCount-1);
  yahtzeeBonusUsedThisTurn = yahtzeeBonusUsedPrev;
  lastAction=null;
  renderPlayerCard();
}

function nextPlayer(){ 
  yahtzeeBonusUsedThisTurn = false;
  currentPlayerIndex=(currentPlayerIndex+1)%players.length; 
  renderPlayerCard(); 
}

// --- Running Totals ---
function updateRunningTotals(){
  const totalsDiv = document.getElementById("runningTotals");
  if(!totalsDiv) return;
  let html = "";
  players.forEach(p=>{
    const upperTotal = ["Aces","Twos","Threes","Fours","Fives","Sixes"].reduce((s,c)=>s+(p.scores[c]||0),0);
    const bonus = upperTotal>=63?35:0;
    const lowerTotal = ["3 of a Kind","4 of a Kind","Full House","Small Straight","Large Straight","Yahtzee","Yahtzee Bonus","Chance"].reduce((s,c)=>s+(p.scores[c]||0),0);
    const grand = upperTotal+bonus+lowerTotal;
    html += `<strong>${p.name}:</strong> ${grand} &nbsp; `;
  });
  totalsDiv.innerHTML = html;
}

// --- End game modal ---
function showEndGameModal(){ document.getElementById("endGameModal").style.display="flex"; }
function closeEndGameModal(){ document.getElementById("endGameModal").style.display="none"; }
function endGame(save){
  closeEndGameModal();

  const results = players.map(p=>{
    const upperTotal = ["Aces","Twos","Threes","Fours","Fives","Sixes"].reduce((s,c)=>s+(p.scores[c]||0),0);
    const bonus = upperTotal>=63?35:0;
    const lowerTotal = ["3 of a Kind","4 of a Kind","Full House","Small Straight","Large Straight","Yahtzee","Yahtzee Bonus","Chance"].reduce((s,c)=>s+(p.scores[c]||0),0);
    const grand = upperTotal+bonus+lowerTotal;
    return { name: p.name, total: grand };
  });

  const highest = Math.max(...results.map(r=>r.total));
  const winners = results.filter(r=>r.total === highest).map(r=>r.name);

  let summaryHTML = "";
  results.forEach(r=>{
    const isWinner = winners.includes(r.name);
    summaryHTML += `<div style="margin:5px 0; ${isWinner?"font-weight:bold; color:#007acc;":""}">${r.name}: ${r.total}</div>`;
  });
  summaryHTML += `<p style="margin-top:10px;">ðŸŽ‰ Congratulations ${winners.join(", ")}!</p>`;
  document.getElementById("summaryContent").innerHTML = summaryHTML;
  document.getElementById("summaryModal").style.display = "flex";

  if(save){
    gameHistory.push({date:new Date(),result:players.map(p=>({name:p.name,scores:p.scores}))});
    localStorage.setItem("yahtzeeGameHistory",JSON.stringify(gameHistory));
    db.collection("yahtzeeGames").add({date:new Date(),result:players.map(p=>({name:p.name,scores:p.scores}))});
  }

  players=[]; currentPlayerIndex=0; turnMode=false; pendingYahtzeeBonus=false; yahtzeeBonusUsedThisTurn=false;
  document.getElementById("playerSetup").style.display="flex";
  document.getElementById("playerCardContainer").style.display="none";
  document.getElementById("footer").style.display="none";
  renderPlayerList();
  updateStatsDashboard();
}
function closeSummaryModal(){ document.getElementById("summaryModal").style.display="none"; }

// --- Stats Dashboard ---
function showStats(){ document.getElementById("statsDashboard").style.display="block"; updateStatsDashboard(); }
function hideStats(){ document.getElementById("statsDashboard").style.display="none"; }
function toggleStats(name){
  const details=document.getElementById("stats-"+name);
  details.style.display=details.style.display==="none"?"block":"none";
}
function updateStatsDashboard(){
  const dash=document.getElementById("statsDashboard"); 
  dash.innerHTML="";
  if(gameHistory.length===0){ 
    dash.innerHTML="<p>No game data yet.</p>"; 
    return; 
  }
  const stats={};
  gameHistory.forEach(game=>{
    game.result.forEach(p=>{
      if(!stats[p.name]) stats[p.name]={games:0,wins:0,yahtzees:0,totalScore:0};
      stats[p.name].games++;
      const upperTotal=["Aces","Twos","Threes","Fours","Fives","Sixes"].reduce((s,c)=>s+(p.scores[c]||0),0);
      const bonus=upperTotal>=63?35:0;
      const lowerTotal=["3 of a Kind","4 of a Kind","Full House","Small Straight","Large Straight","Yahtzee","Yahtzee Bonus","Chance"].reduce((s,c)=>s+(p.scores[c]||0),0);
      const grand=upperTotal+bonus+lowerTotal;
      stats[p.name].totalScore+=grand;
      if(p.scores["Yahtzee"]===50) stats[p.name].yahtzees++;
    });
    const totals=game.result.map(p=>{
      const upperTotal=["Aces","Twos","Threes","Fours","Fives","Sixes"].reduce((s,c)=>s+(p.scores[c]||0),0);
      const bonus=upperTotal>=63?35:0;
      const lowerTotal=["3 of a Kind","4 of a Kind","Full House","Small Straight","Large Straight","Yahtzee","Yahtzee Bonus","Chance"].reduce((s,c)=>s+(p.scores[c]||0),0);
      return {name:p.name,total:upperTotal+bonus+lowerTotal};
    });
    const high=Math.max(...totals.map(r=>r.total));
    totals.forEach(r=>{ if(r.total===high) stats[r.name].wins++; });
  });

  // render per-player cards
  Object.keys(stats).forEach(name=>{
    const s=stats[name];
    const avg=Math.round(s.totalScore/s.games);
    const card=document.createElement("div");
    card.className="stat-card";
    card.innerHTML=`<h3 onclick="toggleStats('${name}')">${name}</h3>
      <div id="stats-${name}" style="display:none;">
        <div class="stat-item"><span>Games Played</span><span>${s.games}</span></div>
        <div class="stat-item"><span>Wins</span><span>${s.wins}</span></div>
        <div class="stat-item"><span>Yahtzees</span><span>${s.yahtzees}</span></div>
        <div class="stat-item"><span>Average Score</span><span>${avg}</span></div>
        <button onclick="resetStats('${name}')">Delete This Playerâ€™s Data</button>
      </div>`;
    dash.appendChild(card);
  });

  // add global delete button
  const delBtn=document.createElement("button");
  delBtn.textContent="Delete All Data";
  delBtn.style.marginTop="10px";
  delBtn.onclick=()=>{ resetAllStats(); };
  dash.appendChild(delBtn);
}

function resetStats(name) {
  if (!confirm(`Delete all data for ${name}?`)) return;

  // Update local memory
  gameHistory = gameHistory.map(game => {
    return {
      ...game,
      result: game.result.filter(p => p.name !== name)
    };
  }).filter(game => game.result.length > 0); // remove empty games

  localStorage.setItem("yahtzeeGameHistory", JSON.stringify(gameHistory));

  // Update Firestore
  db.collection("yahtzeeGames").get().then(snapshot => {
    snapshot.forEach(doc => {
      let data = doc.data();
      let newResult = data.result.filter(p => p.name !== name);
      if (newResult.length === 0) {
        // delete game if no players left
        db.collection("yahtzeeGames").doc(doc.id).delete();
      } else {
        // update game with remaining players
        db.collection("yahtzeeGames").doc(doc.id).update({ result: newResult });
      }
    });
  });

  updateStatsDashboard();
}

function resetAllStats(){
  if(!confirm("Are you sure you want to delete ALL game data?")) return;
  gameHistory=[];
  localStorage.removeItem("yahtzeeGameHistory");
  db.collection("yahtzeeGames").get().then(snapshot=>{
    snapshot.forEach(doc=>{ db.collection("yahtzeeGames").doc(doc.id).delete(); });
  });
  updateStatsDashboard();
}

</script>

<script>
if("serviceWorker" in navigator){ navigator.serviceWorker.register("service-worker.js"); }
</script>
</body>
</html>
